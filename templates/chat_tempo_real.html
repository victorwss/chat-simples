{% extends "logado.html" %}
{% block titulo %}Chat - {{sala.nome}}{% endblock %}
{% block js %}
    {{ super() }}

    const urlMensagens = "{{ url_for('mensagens', chat_id = sala.chat_id, last_msg_id = -1) }}";
    const urlEnvio = "{{ url_for('postar', chat_id = sala.chat_id) }}";
    const eu = "{{ usuario_logado.login }}";

    let ultimaMensagem = 0;
    let requisicaoAtiva = null;

    // Retirado de https://stackoverflow.com/a/6234804/540552
    function escapeHtml(unsafe) {
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

    function montarHora(t) {
        function dois(m) {
            if (m < 10) return "0" + m;
            return "" + m;
        }
        return `${dois(t.dia)}/${dois(t.mes)}/${t.ano} ${dois(t.hora)}:${dois(t.minuto)}:${dois(t.segundo)}`;
    }

    function montarMensagem(item) {
        console.log(item);
        const autor = `<div class="autor">${escapeHtml(item.autor.nome)}</div>`;
        const hora = `<div class="timestamp">${montarHora(item.hora)}</div>`;
        const msg = `<div class="conteudo">${item.texto}</div>`;
        const meu = eu === item.autor.login;
        const k = meu ? "meu" : "";
        const b1 = meu ? "" : "üó®Ô∏è";
        const b2 = meu ? "üí¨" : "";
        const tudo = `<div class="mensagem-chat ${k}" id="msg_${item.msg_id}">${b1}${autor} - ${hora}${b2}${msg}</div>`;
        return tudo;
    }

    function atualizar() {
        // Se h√° uma requisi√ß√£o ativa incompleta, pula esta atualiza√ß√£o.
        if (requisicaoAtiva !== null && requisicaoAtiva.readyState !== 4) return;

        // Se esta √© a primetira vez que est√° atualizando ou a anterior j√° terminou, cria uma nova.
        requisicaoAtiva = new XMLHttpRequest();

        // O m√©todo open aceita mais tr√™s par√¢metros opcionais.
        // O primeiro diz se √© ass√≠ncrono (true, o padr√£o) ou n√£o (false). NUNCA use AJAX s√≠ncrono.
        // Os outros dois s√£o o login e a senha para o caso de a URL demandar autoriza√ß√£o em cabe√ßalhos HTTP.
        console.log(ultimaMensagem);
        requisicaoAtiva.open("GET", urlMensagens.replace("-1", ultimaMensagem + 1));

        // O Ajax √† moda antiga utilizava o m√©todo onreadystatechange e era necess√°rio verificar se o
        // requisicaoAtiva.readyState tem o valor 4 (0 = requisi√ß√£o n√£o enviada, 1 = m√©todo open chamado,
        // 2 = cabe√ßalhos recebidos, 3 = fazendo download, e responseText contendo dados parciais, 4 = conclu√≠do).
        // Entretanto, no presente, usar onprogress, onload e onerror √© uma alternativa que produz um c√≥digo mais limpo.
        requisicaoAtiva.onload = function() {
            if (requisicaoAtiva.status !== 200) {
                console.log(requisicaoAtiva.responseText);
            } else {
                let mensagens = JSON.parse(requisicaoAtiva.responseText).mensagens;
                let div = document.querySelector("#historico");
                for (let idx in mensagens) {
                    const item = mensagens[idx];
                    const msg = montarMensagem(item);
                    div.insertAdjacentHTML("beforeend", msg);
                    ultimaMensagem = item.msg_id;
                }
                div.scrollTop = div.scrollHeight;
            }
        };
        requisicaoAtiva.onerror = function() {
            console.log(requisicaoAtiva.responseText);
        }
        requisicaoAtiva.timeout = 1000;
        requisicaoAtiva.send();
    }

    const poll = setInterval(atualizar, 1000);

    function enviarMensagem() {
        let rq = new XMLHttpRequest();
        rq.open("POST", urlEnvio);
        area = document.querySelector("#nova_mensagem textarea");
        rq.send(area.value);
        area.value = "";
    }
{% endblock %}
{% block conteudo %}
    <h1>Sala {{sala.nome}}</h1>
    <div id="historico"></div>
    <div id="nova_mensagem">
        <textarea></textarea>
        <button type="button" onclick="javascript:enviarMensagem()">Enviar</button>
        <a href="{{ url_for('menu') }}">Voltar</a>
    </div>
{% endblock %}